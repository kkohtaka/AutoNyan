---
name: Dependabot Auto-Merge

run-name: 'Auto-Merge Check - PR #${{ github.event.pull_request.number }} (${{ github.event.pull_request.title }})'

on:
  pull_request_target:
    types: [opened, reopened, synchronize, edited]

permissions:
  contents: write
  pull-requests: write

# Prevent concurrent runs for the same PR to avoid race conditions
concurrency:
  group: dependabot-auto-merge-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Run only for Dependabot PRs
    if: github.actor == 'dependabot[bot]'

    steps:
      # Check auto-merge status early and skip if already enabled
      - name: Check auto-merge status
        id: check-automerge
        run: |
          # Check if auto-merge is already enabled for this PR
          if [ -n "${{ github.event.pull_request.auto_merge }}" ]; then
            echo "✅ Auto-merge is already enabled for PR #${{ github.event.pull_request.number }}"
            echo "⏭️  Skipping workflow - no action needed"
            echo "already_enabled=true" >> $GITHUB_OUTPUT
          else
            echo "already_enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Enable auto-merge
        # Only run if auto-merge is not already enabled
        id: enable-automerge
        if: steps.check-automerge.outputs.already_enabled != 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr merge --auto --rebase "$PR_NUMBER" \
            --repo "${{ github.repository }}"
          echo "✅ Auto-merge enabled for PR #${PR_NUMBER}"

      - name: Comment on auto-merge failure
        # Only run if enable-automerge step failed
        if: steps.enable-automerge.outcome == 'failure'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr comment "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --body "⚠️ **Failed to enable auto-merge for Dependabot PR**

          The workflow attempted to enable auto-merge but encountered an error.
          This may be due to:
          - Branch protection rules preventing auto-merge
          - Permissions issues
          - PR state incompatible with auto-merge

          Please check the workflow logs and enable auto-merge manually if needed."
