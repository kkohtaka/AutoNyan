---
name: Deploy

run-name: Deploy to Production (${{ inputs.deploy_ref }})

on:
  workflow_dispatch:
    inputs:
      deploy_ref:
        description: 'Git ref to deploy'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
    concurrency:
      group: production
    env:
      NODE_OPTIONS: --max-old-space-size=4096

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.deploy_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup Terraform backend
        run: npm run setup:terraform-backend
        env:
          TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
          TF_STATE_LOCATION: ${{ vars.TF_STATE_LOCATION }}

      - name: Generate terraform.tfvars
        run: npm run setup:terraform-variables
        env:
          GCP_REGION: ${{ vars.TF_STATE_LOCATION }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
          DRIVE_SCANNER_SCHEDULE: ${{ vars.DRIVE_SCANNER_SCHEDULE }}

      - name: Deploy infrastructure
        id: deploy
        run: |
          npm run terraform:init
          npm run terraform:apply 2>&1 | tee deploy_output.txt
          echo "deploy_exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Report deployment status
        if: always()
        run: |
          EXIT_CODE="${{ steps.deploy.outputs.deploy_exit_code }}"
          if [ "$EXIT_CODE" = "0" ]; then
            echo "✅ Deployment to production completed successfully"
            echo "Deployed ref: ${{ inputs.deploy_ref }}"
          else
            echo "❌ Deployment to production failed"
            echo "Deploy ref: ${{ inputs.deploy_ref }}"
            exit 1
          fi
