---
name: Terraform Plan

run-name: |
  ${{
    github.event_name == 'issue_comment' &&
    format('Manual Plan - PR #{0} ({1})', github.event.issue.number, github.event.comment.user.login) ||
    github.event_name == 'workflow_dispatch' && inputs.pr_number &&
    format('Auto Plan - PR #{0} ({1})', inputs.pr_number, inputs.pr_ref) ||
    github.event_name == 'workflow_dispatch' &&
    format('Auto Plan - {0} ({1})', github.ref_name, github.sha) ||
    'Terraform Plan'
  }}

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number (for auto-triggered runs)'
        required: false
        type: number
      pr_ref:
        description: 'Git ref from PR (for auto-triggered runs)'
        required: false
        type: string
      pr_sha:
        description: 'Git SHA from PR (for auto-triggered runs)'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write
  id-token: write
  statuses: write
  actions: write

concurrency:
  # Serializes all Terraform plan operations to prevent concurrent plans.
  # Note: Deploys use 'terraform-{environment}' groups for environment-specific
  # serialization, allowing plans and deploys to potentially overlap.
  # Terraform's state locking mechanism provides the final coordination.
  group: terraform
  cancel-in-progress: false

jobs:
  terraform-plan:
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/terraform plan') &&
       (github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR')) ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max-old-space-size=4096

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            if (context.eventName === 'issue_comment') {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              return {
                ref: pr.head.ref,
                sha: pr.head.sha,
                repo: pr.head.repo.full_name,
                number: context.issue.number
              };
            } else if (context.eventName === 'workflow_dispatch') {
              const inputs = context.payload.inputs;
              if (inputs.pr_number) {
                // Auto-triggered from Test workflow with PR info
                return {
                  ref: inputs.pr_ref,
                  sha: inputs.pr_sha,
                  repo: context.repo.full_name,
                  number: parseInt(inputs.pr_number)
                };
              } else {
                // Manual dispatch or push to master
                return {
                  ref: context.ref.replace('refs/heads/', ''),
                  sha: context.sha,
                  repo: context.repo.full_name,
                  number: null
                };
              }
            }

      - name: Comment acknowledgment for manual trigger
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v8
        with:
          script: |
            const prDetails = ${{ steps.pr.outputs.result }};
            const issueNumber = prDetails.number;

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ **Terraform Plan Started**\n\n` +
                    `Triggered by @${{ github.event.comment.user.login }} with command: \`/terraform plan\`\n\n` +
                    `Plan execution is now running... Check the ` +
                    `[workflow run](${{ github.server_url }}/${{ github.repository }}/` +
                    `actions/runs/${{ github.run_id }}) for progress.`
            });

      - name: Set status to pending
        uses: actions/github-script@v8
        with:
          script: |
            const prDetails = ${{ steps.pr.outputs.result }};
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: prDetails.sha,
              state: 'pending',
              context: 'terraform/plan',
              description: 'Terraform plan is running...',
              target_url: `${context.serverUrl}/${context.repo.owner}/` +
                          `${context.repo.repo}/actions/runs/${context.runId}`
            });

      - name: Checkout PR code
        uses: actions/checkout@v5
        with:
          ref: ${{ fromJson(steps.pr.outputs.result).sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup Terraform backend
        run: npm run setup:terraform-backend
        env:
          TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
          TF_STATE_LOCATION: ${{ vars.TF_STATE_LOCATION }}

      - name: Generate terraform.tfvars
        run: npm run setup:terraform-variables
        env:
          GCP_REGION: ${{ vars.TF_STATE_LOCATION }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
          DRIVE_SCANNER_SCHEDULE: ${{ vars.DRIVE_SCANNER_SCHEDULE }}

      - name: Run Terraform plan
        id: plan
        run: |
          npm run build:function
          npm run terraform:init
          npm run terraform:plan 2>&1 | tee plan_output.txt
          PLAN_EXIT_CODE=${PIPESTATUS[0]}
          echo "plan_exit_code=${PLAN_EXIT_CODE}" >> $GITHUB_OUTPUT
          exit ${PLAN_EXIT_CODE}

      - name: Comment PR with plan results
        if: steps.pr.outputs.result && fromJson(steps.pr.outputs.result).number != null
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('plan_output.txt', 'utf8');
            const exitCode = '${{ steps.plan.outputs.plan_exit_code }}';

            const success = exitCode === '0';
            const emoji = success ? '‚úÖ' : '‚ùå';
            const status = success ? 'SUCCESS' : 'FAILED';

            const triggerInfo = context.eventName === 'issue_comment'
              ? `*Triggered by comment from @${{ github.event.comment.user.login }}*`
              : `*Auto-triggered after Test workflow success*`;

            const prDetails = ${{ steps.pr.outputs.result }};
            const issueNumber = prDetails.number;

            const body = `## ${emoji} Terraform Plan ${status}

            <details>
            <summary>Click to expand plan output</summary>

            \`\`\`
            ${planOutput}
            \`\`\`
            </details>

            ${triggerInfo}`;

            github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Set final status
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const prDetails = ${{ steps.pr.outputs.result }};
            const exitCode = '${{ steps.plan.outputs.plan_exit_code }}';
            const success = exitCode === '0';

            const state = success ? 'success' : 'failure';
            const description = success
              ? 'Terraform plan completed successfully'
              : 'Terraform plan failed';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: prDetails.sha,
              state: state,
              context: 'terraform/plan',
              description: description,
              target_url: `${context.serverUrl}/${context.repo.owner}/` +
                          `${context.repo.repo}/actions/runs/${context.runId}`
            });

            if (!success) {
              core.setFailed('Terraform plan failed');
            }

      - name: Trigger Deploy workflow (master branch only)
        if: |
          steps.plan.outputs.plan_exit_code == '0' &&
          github.event_name == 'workflow_dispatch' &&
          fromJson(steps.pr.outputs.result).ref == 'master'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: context.ref,
              inputs: {
                deploy_ref: context.ref
              }
            });

            console.log(`Triggered Deploy workflow for ref ${context.ref}`);
