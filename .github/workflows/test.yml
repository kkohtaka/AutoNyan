---
name: Test

run-name: |
  ${{
    github.event_name == 'pull_request' &&
    format('Test - PR #{0} ({1})', github.event.pull_request.number, github.event.pull_request.head.ref) ||
    github.event_name == 'push' &&
    format('Test - {0} ({1})', github.ref_name, github.sha) ||
    'Test'
  }}

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

permissions:
  checks: write
  contents: read
  pull-requests: read
  actions: write

jobs:
  lint-functions:
    runs-on: ubuntu-latest
    env:
      # Reduced from 4096MB: type checking disabled for test files + .eslintignore reduces file set
      NODE_OPTIONS: --max-old-space-size=2048
    strategy:
      matrix:
        function:
          [
            doc-processor,
            drive-scanner,
            file-classifier,
            text-firebase-writer,
            text-vision-processor,
          ]

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared library
        run: npm run build --workspace=src/shared

      - name: Build ${{ matrix.function }}
        run: npm run build --workspace=src/functions/${{ matrix.function }}

      - name: Run TypeScript linter for ${{ matrix.function }}
        run: npm run lint --workspace=src/functions/${{ matrix.function }}

  lint-global:
    runs-on: ubuntu-latest
    env:
      # Reduced from 4096MB: still needs more memory for Terraform + multi-tool linting
      NODE_OPTIONS: --max-old-space-size=3072

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install shellcheck, shfmt and yamllint
        run: sudo apt-get update && sudo apt-get install --no-install-recommends -y shellcheck shfmt yamllint

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.8.5'

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v6
        with:
          tflint_version: v0.50.3

      - name: Run YAML linter
        run: yamllint .github/ -c .yamllint.yml

      - name: Run JSON linter
        run: npx eslint '**/*.json'

      - name: Run ShellCheck
        run: shellcheck scripts/*.sh

      - name: Run shfmt
        run: shfmt -d scripts/*.sh

      - name: Run Terraform linter
        run: npm run lint:terraform

      - name: Run Terraform validation (no backend)
        run: |
          cd terraform
          terraform init -backend=false
          terraform validate

      - name: Check code formatting
        run: |
          npm run format
          if [ -n "$(git status --porcelain)" ]; then
            echo "Code formatting issues found. Please run 'npm run format' locally."
            git status --porcelain
            git diff
            exit 1
          fi

  test-functions:
    runs-on: ubuntu-latest
    needs: [lint-functions, lint-global]
    env:
      # Reduced from 4096MB: Jest workerIdleMemoryLimit prevents memory leaks
      NODE_OPTIONS: --max-old-space-size=2048
    strategy:
      matrix:
        function:
          [
            doc-processor,
            drive-scanner,
            file-classifier,
            text-firebase-writer,
            text-vision-processor,
          ]

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests for ${{ matrix.function }}
        run: npm test --workspace=src/functions/${{ matrix.function }}

      - name: Run coverage for ${{ matrix.function }}
        id: coverage
        run: npm run test:coverage --workspace=src/functions/${{ matrix.function }}
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: ${{ matrix.function }}
          name: codecov-${{ matrix.function }}
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: Fail if coverage thresholds not met
        if: steps.coverage.outcome == 'failure'
        run: exit 1

  test:
    runs-on: ubuntu-latest
    needs: [test-functions]
    steps:
      - name: All tests and coverage checks passed
        run: echo "âœ… All tests and coverage checks completed successfully"

  trigger-terraform-plan:
    runs-on: ubuntu-latest
    needs: [test]
    if: |
      (github.event_name == 'pull_request' &&
       (github.event.pull_request.user.login == 'dependabot[bot]' ||
        github.event.pull_request.user.login == github.repository_owner)) ||
      (github.event_name == 'push' && github.ref == 'refs/heads/master')
    steps:
      - name: Trigger Terraform Plan workflow
        uses: actions/github-script@v8
        with:
          script: |
            const isPR = context.eventName === 'pull_request';
            const inputs = {};
            let targetRef = 'master';

            if (isPR) {
              inputs.pr_number = context.payload.pull_request.number.toString();
              inputs.pr_ref = context.payload.pull_request.head.ref;
              inputs.pr_sha = context.payload.pull_request.head.sha;
              targetRef = context.payload.pull_request.head.ref;
            }

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'terraform-plan.yml',
              ref: targetRef,
              inputs: inputs
            });

            console.log(`Triggered Terraform Plan workflow for ${isPR ? 'PR #' + inputs.pr_number : 'master push'}`);
