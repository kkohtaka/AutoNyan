---
name: Unlock Terraform State (Manual)

run-name: |
  Unlock Terraform State - ${{ inputs.confirm == 'UNLOCK' && '‚úÖ Confirmed' || '‚ùå Not Confirmed' }}

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "UNLOCK" to confirm'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

concurrency:
  # Use the same concurrency group as plan/deploy to ensure mutual exclusion.
  # This ensures the unlock workflow cannot run while Terraform operations are in progress,
  # and vice versa. This provides stronger guarantees than checking with gh CLI.
  group: terraform-production
  cancel-in-progress: false

jobs:
  unlock:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "UNLOCK" ]; then
            echo "‚ùå Confirmation failed. Please type 'UNLOCK' to proceed."
            exit 1
          fi
          echo "‚úÖ Confirmation validated"
          echo ""
          echo "‚ÑπÔ∏è  Note: This workflow uses the 'terraform-production' concurrency group."
          echo "If other Terraform operations are running, this workflow will wait for them to complete."

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.8.5'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup Terraform backend
        run: |
          cat > terraform/backend.hcl <<EOF
          bucket = "${{ vars.TF_STATE_BUCKET }}"
          prefix = "terraform/state"
          EOF

      - name: Initialize Terraform
        run: terraform -chdir=terraform init -backend-config=backend.hcl

      - name: Get lock information
        id: lock_info
        run: |
          LOCK_FILE="gs://${{ vars.TF_STATE_BUCKET }}/terraform/state/default.tflock"

          echo "Checking for lock file: ${LOCK_FILE}"

          # Note: Using 'gcloud storage' instead of 'gsutil' because gsutil does not
          # support Workload Identity Federation credentials. See:
          # https://github.com/google-github-actions/auth#authenticating-via-workload-identity-federation
          if gcloud storage ls "${LOCK_FILE}" 2>/dev/null; then
            echo "üîì Lock file found. Retrieving details..."
            gcloud storage ls -l "${LOCK_FILE}"
            echo ""

            # Get lock file content
            LOCK_CONTENT=$(gcloud storage cat "${LOCK_FILE}" 2>/dev/null || echo "")

            if [ -n "$LOCK_CONTENT" ]; then
              # Extract lock ID from JSON using jq
              LOCK_ID=$(echo "$LOCK_CONTENT" | jq -r '.ID // empty')

              if [ -n "$LOCK_ID" ]; then
                echo "lock_id=${LOCK_ID}" >> $GITHUB_OUTPUT
                echo "lock_exists=true" >> $GITHUB_OUTPUT
                echo "Lock ID: ${LOCK_ID}"
              else
                echo "lock_exists=false" >> $GITHUB_OUTPUT
                echo "‚ö†Ô∏è  Could not extract lock ID from lock file"
              fi
            else
              echo "lock_exists=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è  Lock file is empty"
            fi
          else
            echo "lock_exists=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No lock file found"
          fi

      - name: Remove Terraform state lock
        if: steps.lock_info.outputs.lock_exists == 'true'
        run: |
          LOCK_FILE="gs://${{ vars.TF_STATE_BUCKET }}/terraform/state/default.tflock"
          LOCK_ID="${{ steps.lock_info.outputs.lock_id }}"

          echo "Removing Terraform state lock..."
          echo "Lock ID: ${LOCK_ID}"
          echo "Lock file: ${LOCK_FILE}"

          # Note: The GCS backend uses UUID-format lock IDs, but 'terraform force-unlock'
          # expects numerical lock IDs. Therefore, we delete the lock file directly.
          # This is safe because:
          # 1. The concurrency group ensures no other Terraform operations are running
          # 2. This workflow requires manual confirmation before execution
          if gcloud storage rm "${LOCK_FILE}"; then
            echo "‚úÖ Lock removed successfully"
          else
            echo "‚ö†Ô∏è  Failed to remove lock file"
            exit 1
          fi

      - name: Post-unlock summary
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "Terraform State Unlock Summary"
          echo "========================================="
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Lock exists: ${{ steps.lock_info.outputs.lock_exists }}"
          if [ "${{ steps.lock_info.outputs.lock_exists }}" == "true" ]; then
            echo "Lock ID: ${{ steps.lock_info.outputs.lock_id }}"
          fi
          echo ""
          echo "Next steps:"
          echo "  1. Verify no failed workflows in GitHub Actions"
          echo "  2. Run terraform plan to ensure state is accessible"
          echo "  3. Monitor for any lock errors in future runs"
          echo "========================================="
